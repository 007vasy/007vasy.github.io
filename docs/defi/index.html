<head>
    <title>Defi Universe</title>
    <style> body { margin: 0; } </style>
    <script src="//unpkg.com/three"></script>
    <script src="https://unpkg.com/3d-force-graph"></script>
  <!--  <script src="../../dist/3d-force-graph.js"></script>-->
  </head>
  
  <body>
  
    <div id="3d-graph"></div>
    <p>Loading...</p>
    <script>
      const url = 'https://api.llama.fi/protocols'
      
      async function getData(url) {
        let resp = await fetch(url);
        let info_json = await resp.json();
        
        let converted_info_json = {
          nodes: [],
          links: [],
        };

        

        info_json.forEach(protocol => {
          // Creating Protocol Nodes
          converted_info_json.nodes.push(
            {
              id: protocol.id,
              slug: protocol.slug,
              name: protocol.name,
              tvl: protocol.tvl,
              logo: protocol.logo,
              type: "Protocol",
              color: "cyan"
            }
          )
          
          if(protocol.hasOwnProperty('oracles') && protocol.oracles.length > 0) {
            protocol.oracles.forEach(oracle => {
              // Creating Oracle Nodes
              let oracle_name = oracle

              if(oracle.toLowerCase() == "internal" ){
                oracle_name += "_" + protocol.slug
              }

              converted_info_json.nodes.push(
                {
                  id: oracle_name,
                  name: oracle_name,
                  type: "Oracle",
                  color: "red"
                }
              )
          
              // Creating Protocol - Oracle edges
              converted_info_json.links.push(
                {
                  source: oracle_name,
                  target: protocol.id,
                  type: "Oracle2Protocol",
                  particles: 2
                }
              )
          
              })
          }

          if(protocol.hasOwnProperty('chains')){
            protocol.chains.forEach(chain => {
              // Creating Chain Nodes
              converted_info_json.nodes.push(
                {
                  id: chain,
                  name: chain,
                  type: "Chain",
                  color: "orange"
                }
              )
              // Creating Protocol - Chain edges
              converted_info_json.links.push(
                {
                  source: protocol.id,
                  target: chain,
                  type: "Protocol2Chain",
                  particles: 0
                }
              )

          
              })
          }

        })




        function uniqByKeepFirst(a, key) {
          let seen = new Set();
          return a.filter((item) => {
            let k = key(item);
            return seen.has(k) ? false : seen.add(k);
          });
        }

        converted_info_json.nodes = uniqByKeepFirst(
          converted_info_json.nodes,
          (item) => item.id
        );

        converted_info_json.nodes.forEach((node) => {
          let source = node.name
          let count = 0

          if(node.type === "Protocol"){
            source = node.id
          }
          converted_info_json.links.forEach(link => {
            if (link.source == source){
              count += 1;
            };

            if (node.type === "Chain" && link.target == source){
              count += 1;
            }
            
          })
          
          node.count = count
          
        })

        return converted_info_json

      }


      function doNodeThreeObject(node) {
          return new THREE.Mesh(
            // use logarithmic scale for node size
            new THREE.SphereGeometry(Math.max(Math.log(node.count)*4,2)),
              new THREE.MeshLambertMaterial({
                color: node.color,
                transparent: true,
                opacity: 0.75
              })
            )
        }



      async function render() {
        const networkData = await getData(url);


        const elem = document.getElementById('3d-graph');
    
        const Graph = ForceGraph3D(
        //     {
        //   extraRenderers: [new THREE.CSS2DRenderer()]
        // }
        )(elem)
          .graphData(networkData)
          .nodeLabel(node => `${node.type}: ${node.name}, ${node.count}`)
          .linkOpacity(0.1)
          .linkAutoColorBy('type')
          .linkDirectionalParticles('particles')
          .onNodeClick(node => window.open("https://api.llama.fi/protocol/" + node.slug, '_blank'))
          .nodeThreeObject(node => { return doNodeThreeObject(node)})
      }
      render().then()

    </script>
  </body>